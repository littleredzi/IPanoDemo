$(function(){
  setTimeout(function(){
  if(config.debug){console.log(THREE);console.log(new THREE.Object3D())}window.scene;window.camera;var T,ab,S=$("#container");var o=false;var O,R;var ar;var v=0.5;var y=100,f=40;var W=config.cubeWidth;var aa=0,Z=0,Y=0;var j=false;var D=0,B=0;var g=0,e=0;var P=0,J=0;var at=0,x=0;var n,m;var an=[];var al=true;var aj,ag,I,G;var ad,ac,E,C;var ap=THREE.Texture();var N="allinone.jpg";var l=[];var c=0;$(".map-switch").on("touchstart",function(){if($(this).hasClass("on")){$(this).removeClass("on");$(this).addClass("off")}else{$(this).removeClass("off");$(this).addClass("on")}});$(".music-switch").on("touchstart",function(){if($(this).hasClass("on")){$(this).removeClass("on");$(this).addClass("off")}else{$(this).removeClass("off");$(this).addClass("on")}});$(".comment-switch").on("touchstart",function(){if($(this).hasClass("on")){$(".comment").hide();$(this).removeClass("on");$(this).addClass("off")}else{$(".comment").show();$(this).removeClass("off");$(this).addClass("on")}});$(".item").click(function(){$(".check").addClass("hide");$(this).find(".check").removeClass("hide");$(".romaing-input").val($(this).attr("data-name"));$(".romaing-input").attr("data-id",$(this).attr("data-id"))});$(".edit-cancel").click(function(){$(".romaing-editor").hide();o=false});$(".edit-delete").click(function(){$.ajax({url:"/spot-delete",type:"POST",async:false,timeout:1000,data:{link_id:$(".romaing-editor").attr("current-id"),scene_id:config.scene_id},success:function(i){if(i.code!=0){alert(i.msg);return}$(".edit-cancel").click();scene.remove(scene.getChildByName("spot_id_"+$(".romaing-editor").attr("current-id")))},error:function(i){alert(i)}})});$(".edit-add").on("click",function(){if(!$(".romaing-input").attr("data-id")){alert("无法添加");return}var i={text:$(".romaing-input").val(),scene_id:config.scene_id,go_scene:$(".romaing-input").attr("data-id")};if($(".editor-modify").hasClass("hide")){i.position_x=ar.x;i.position_y=ar.y;i.position_z=ar.z}else{i.link_id=$(".romaing-editor").attr("current-id")}$.ajax({url:"/spot-post",type:"POST",async:false,timeout:1000,data:i,success:function(au){if(au.code!="0"){alert(au.msg);return}if($(".editor-modify").hasClass("hide")){var av=F("spot",$(".romaing-input").val(),au.id,"?",u);q(av,ar.x,ar.y,ar.z)}else{$("#spot_id_"+$(".romaing-editor").attr("current-id")).text($(".romaing-input").val())}$(".edit-cancel").click()},error:function(au){alert(au)}})});var H=[config.localImagesPath+"/negx.jpg",config.localImagesPath+"/negy.jpg",config.localImagesPath+"/negz.jpg",config.localImagesPath+"/posx.jpg",config.localImagesPath+"/posy.jpg",config.localImagesPath+"/posz.jpg"];for(var ak=0;ak<6;++ak){var s;if(config.local){$(".loader").hide();s=document.createElement("img");s.height=W+2;s.width=W+2;s.src=H[ak]}else{s=document.createElement("img");s.crossOrigin="*";s.height=W+2;s.width=W+2;s.src=config.cdnImagesPath+"/scenes/"+config.scene_key+"/"+N+"?v="+(new Date()).valueOf()+"&imageMogr2/gravity/NorthWest/crop/!"+W+"x"+W+"a0a"+(W*ak)+"/thumbnail/!10p";s.onload=function(){c++;if(c==6){$(".loader").hide();for(var i in l){l[i].crossOrigin="*";l[i].src=config.cdnImagesPath+"/scenes/"+config.scene_key+"/"+N+"?v="+(new Date()).valueOf()+"&imageMogr2/gravity/NorthWest/crop/!"+W+"x"+W+"a0a"+(W*i)+"/thumbnail/!100p"}ai();ae()}else{if(c==12){}}}}s.style.zIndex=1;l.push(s)}if(config.local){ai();ae()}function af(){var ay=W;var az=[{position:[ay/2,0,0],rotation:[0,-Math.PI/2,0]},{position:[0,-ay/2,0],rotation:[-Math.PI/2,0,Math.PI]},{position:[0,0,-ay/2],rotation:[0,0,0]},{position:[-ay/2,0,0],rotation:[0,Math.PI/2,0]},{position:[0,ay/2,0],rotation:[Math.PI/2,0,Math.PI]},{position:[0,0,ay/2],rotation:[0,Math.PI,0]}];var av=[];for(var ax=0;ax<az.length;ax++){var aw=az[ax];var au=new THREE.CSS3DObject(l[ax]);au.position.fromArray(aw.position);au.rotation.fromArray(aw.rotation);av.push(au)}return av}function t(){THREE.ImageUtils.crossOrigin="*";ap=THREE.ImageUtils.loadTexture(config.imgUrl);var au=new THREE.SphereGeometry(100,40,40);au.applyMatrix(new THREE.Matrix4().makeScale(-1,1,1));var i=new THREE.MeshBasicMaterial({map:ap});return new THREE.Mesh(au,i)}function r(i,aA,ay,au,av,ax){if(config.useCSS3D){}else{var aw=new THREE.Geometry();var az=new THREE.LineBasicMaterial({vertexColrs:THREE.VertexColors});aw.vertices.push(new THREE.Vector3(i,aA,ay));aw.vertices.push(new THREE.Vector3(au,av,ax));aw.colors.push(new THREE.Color(4473924),new THREE.Color(16711680));return new THREE.Line(aw,az,THREE.LinePieces)}}function h(au,az,ay,av){var ax=new THREE.BoxGeometry(av,av,av);var aw=new THREE.MeshBasicMaterial({color:65280});var i=new THREE.Mesh(ax,aw);i.position.x=au;i.position.y=az;i.position.z=ay;return i}function X(){var au="#0c0c0c";var i=new THREE.AmbientLight(au);return i}function A(){var i=new THREE.SpotLight(16777215);i.position.set(40,60,10);i.castShadow=true;return i}function U(aE,aA,ay,aI,aF,aC){var aD=0.5,aB=1,ax=0.5,aw=1;var av=[v3(-aI*ax,0,0),v3(-aI*ax,0,-aI*aB),v3(aI*ax,0,-aI*aB),v3(aI*ax,0,0),v3(aI*ax+aI*aD,0,0),v3(0,0,aI*aw),v3(-aI*ax-aI*aD,0,0)];
var au=[f3(2,1,0),f3(3,2,0),f3(6,5,4)];var az=new THREE.Geometry();var aG=[new THREE.MeshLambertMaterial({opacity:0.6,color:16777215,transparent:true})];az.vertices=av;az.faces=au;az.computeFaceNormals();var aH=THREE.SceneUtils.createMultiMaterialObject(az,aG);aH.children.forEach(function(aJ){aJ.castShadow=true});aH.position.x=aE;aH.position.y=aA;aH.position.z=ay;var i=Math.acos(ay/Math.pow(aE*aE+ay*ay,0.5));if(aE<0){i=2*PI-i}aH.rotation.y=i+aF*PI/180;if(aC){aH.rotation.z=aC*PI/180}return aH}function ao(){ab=new Stats();ab.domElement.style.position="absolute";ab.domElement.style.top="0px";ab.domElement.style.zIndex="10000";return(ab.domElement)}function M(aB,aA,ay,aD,aF){textWidth=text_length(aD)/2*aF;textHeight=aF;var ax=20;var av=document.createElement("canvas");var au=av.getContext("2d");av.style.position="absolute";av.width=textWidth;av.height=textHeight;av.style.bottom=0;av.style.left=0;au=av.getContext("2d");au.font=aF+"px impact";au.fillStyle="#fff";au.textAlign="center";au.shadowColor="rgba(0,0,0,1)";au.shadowOffestX=95;au.shadowOffestX=-90;au.textBaseline="middle";au.fillText(aD,textWidth/2,textHeight/2);var az=new THREE.PlaneGeometry(au.measureText(aD).width/ax,aF/ax,1,1);var aw=new THREE.Texture(av);var aC=new THREE.MeshBasicMaterial({map:aw,transparent:true});aw.needsUpdate=true;var aE=new THREE.Mesh(az,aC);aE.position.set(aB,aA,ay);var i=Math.acos(ay/Math.pow(aB*aB+ay*ay,0.5));if(aB<0){i=2*PI-i}aE.rotation.y=i+PI;return aE}function L(){}function ai(){if(1||navigator.userAgent.indexOf("Android")!=-1){camera=new THREE.PerspectiveCamera(120,window.innerWidth/window.innerHeight,1,1000);S.css("-webkit-transform","scale("+(120/110)+")")}else{camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1000)}camera.target=new THREE.Vector3(0,0,0);scene=new THREE.Scene();if(config.debug){S.append(ao())}if(config.useCSS3D){try{T=new THREE.CSS3DRenderer()}catch(ax){k(ax);alert("您的浏览器太捞")}var av=af();for(var au=0;au<av.length;++au){an.push(av[au]);scene.add(av[au])}q(F("advertisement",'<div class="advertisement-content"><div class="icon logo2"></div><div>速腾聚创</div></div>',0,0,L),1,100,1,PI/2);if(!config.local){q(F("advertisement",'<div class="advertisement-content">'+config.advertisement+"</div>",0,0,L),1,-100,1,-PI/2);for(var au=0;au<preload_links.length;++au){q(F("spot",preload_links[au].text,preload_links[au].id,au,u,preload_links[au].scene_key),preload_links[au].x,preload_links[au].y,preload_links[au].z)}if(preload_comments&&config.type!="edit"){for(var au=0;au<preload_comments.length;++au){var aw=F("comment",preload_comments[au].text,preload_comments[au].id,au,w);q(aw,preload_comments[au].position_x,preload_comments[au].position_y,preload_comments[au].position_z)}}}else{q(F("advertisement",'<div class="advertisement-content">速腾聚创</div>',0,0,L),1,-100,1,-PI/2)}}else{try{T=new THREE.WebGLRenderer()}catch(ax){k(ax);alert("您的浏览器太捞")}try{T.setPixelRatio(window.devicePixelRatio)}catch(ax){k(ax)}an.push(t());scene.add(an[0]);scene.add(U(20,-10,0,10,0,0));scene.add(U(20,-10,0,10,0,90));scene.add(U(20,-10,0,10,0,180));scene.add(U(20,-10,0,10,0,270));scene.add(X());scene.add(A());scene.add(r(0,0,0,0,0,100));scene.add(r(0,0,0,0,100,0));scene.add(r(0,0,0,100,0,0))}T.setSize(window.innerWidth,window.innerHeight);S.append(T.domElement);if(checkMobile()){S.on("touchstart",am,false);S.on("touchmove",b,false);S.on("touchend",V,false)}else{S.on("mousedown",am,false);S.on("mousemove",b,false);S.on("mouseup",V,false)}if(config.debug){S.on("DOMMouseScroll",p,false);S.on("mousewheel",p,false);$("body").on("keydown",aq,false);S.on("dragover",function(i){i.preventDefault();i.dataTransfer.dropEffect="copy"},false);S.on("dragenter",function(i){document.body.style.opacity=0.5},false);S.on("dragleave",function(i){document.body.style.opacity=1},false);S.on("drop",function(ay){ay.preventDefault();var i=new FileReader();i.addEventListener("load",function(az){an[0].material.map.image.src=az.target.result;an[0].material.map.needsUpdate=true},false);i.readAsDataURL(ay.dataTransfer.files[0]);document.body.style.opacity=1},false)}}function d(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();T.setSize(window.innerWidth,window.innerHeight);$(".alert-wrap").height(S.height())}function am(i){i.preventDefault();if(o){return false}j=true;onPointerDownPointerX=parseInt(i.clientX>=0?i.clientX:i.targetTouches[0].clientX);onPointerDownPointerY=parseInt(i.clientY>=0?i.clientY:i.targetTouches[0].clientY);onPointerDownLon=g;onPointerDownLat=P;n=onPointerDownPointerX;m=onPointerDownPointerY}function b(aw){if(o){return false}try{var i=parseInt(aw.clientX>=0?aw.clientX:aw.targetTouches[0].clientX);var az=parseInt(aw.clientY>=0?aw.clientY:aw.targetTouches[0].clientY)}catch(ax){k(ax)}if(aw.touches&&aw.touches.length>1){if(al){Multix1=aw.touches[0].pageX;Multiy1=aw.touches[0].pageY;Multix2=aw.touches[1].pageX;Multiy2=aw.touches[1].pageY;al=false}else{Multix3=aw.touches[0].pageX;Multiy3=aw.touches[0].pageY;
Multix4=aw.touches[1].pageX;Multiy4=aw.touches[1].pageY;var ay=abs(Multix1-Multix2)+abs(Multiy1-Multiy2)-abs(Multix3-Multix4)-abs(Multiy3-Multiy4);var av=1+abs(ay/4);if(ay>0){if(1||navigator.userAgent.indexOf("Android")!=-1){var au=parseFloat(getFloat(S.css("-webkit-transform")));au-=av*0.02;au=au<1?1:au;S.css("-webkit-transform","scale("+au+")")}else{camera.fov=camera.fov+av>y?y:camera.fov+av;camera.updateProjectionMatrix()}}else{if(ay<0){if(1||navigator.userAgent.indexOf("Android")!=-1){var au=parseFloat(getFloat(S.css("-webkit-transform")));au+=av*0.02;au=au<1.5?au:1.5;S.css("-webkit-transform","scale("+au+")")}else{camera.fov=camera.fov-av<f?f:camera.fov-av;camera.updateProjectionMatrix()}}}if(ay!=0){al=true}}}else{if(j===true){var av=0.2;g=(onPointerDownPointerX-i)*av+onPointerDownLon;P=(az-onPointerDownPointerY)*av+onPointerDownLat}}}function z(au,av,aw){var i;i=new THREE.Matrix4();i.makeRotationAxis(av.normalize(),aw);au.matrix.multiply(i);au.rotation.setFromRotationMatrix(au.matrix)}function K(au,av,aw){var i;i=new THREE.Matrix4();i.makeRotationAxis(av.normalize(),aw);i.multiply(au.matrix);au.matrix=i;au.rotation.setFromRotationMatrix(au.matrix)}function aq(ax){if(!o){var av=camera.target.x-camera.position.x;var au=camera.target.y-camera.position.y;var i=camera.target.z-camera.position.z;var aw=3;if(ax.keyCode==83){aa-=aw*av;Z-=aw*au;Y-=aw*i}else{if(ax.keyCode==68){aa-=aw*i;Y+=aw*av}else{if(ax.keyCode==65){aa+=aw*i;Y-=aw*av}else{if(ax.keyCode==87){aa+=aw*av;Z+=aw*au;Y+=aw*i}else{if(ax.keyCode==81){Z+=aw}else{if(ax.keyCode==69){Z-=aw}}}}}}}}function ah(){return new THREE.Matrix4()}var a=false;var u=function(i){if(config.type!="edit"){location.href="/scene?key="+i[0].extra}else{$(".romaing-editor").show();$(".romaing-editor").find(".buttons").addClass("hide");$(".romaing-editor").find(".editor-modify").removeClass("hide");$(".romaing-editor").attr("current-id",getInt(i[0].id))}};var w=function(au){var ax=0.8;if(au.attr("class")=="img-hide"){var av=scene.getObjectByName(au.parent().attr("id"));scene.remove(av);a=true;return}else{if(au.attr("class").indexOf("comment")!=-1){if(a){a=false;return}if(au.attr("data-clicked")=="1"){au.attr("data-clicked","0");au.find(".img-hide").css("visibility","hidden");au.css("background-color","rgba(0,0,0,0.4)");var av=scene.getObjectByName(au.attr("id"));for(var aw=12;aw<15;++aw){av.matrix.elements[aw]/=ax}av.matrixAutoUpdate=false;return}au.css("background-color","rgba(255,0,0,0.5)");if(!au.find(".img-hide").length){au.append($(".img-hide").parent().html());if(!checkMobile()){au.find(".img-hide").on("mouseup",function(ay){var i=parseInt(ay.clientX?ay.clientX:ay.changedTouches[0].clientX);var az=parseInt(ay.clientY?ay.clientY:ay.changedTouches[0].clientY);if(i==n&&az==m){w($(this))}})}else{au.find(".img-hide").on("touchend",function(ay){var i=parseInt(ay.clientX?ay.clientX:ay.changedTouches[0].clientX);var az=parseInt(ay.clientY?ay.clientY:ay.changedTouches[0].clientY);if(i==n&&az==m){w($(this))}})}}au.find(".img-hide").css("visibility","visible");au.attr("data-clicked","1");var av=scene.getObjectByName(au.attr("id"));for(var aw=12;aw<15;++aw){av.matrix.elements[aw]*=ax}av.matrixAutoUpdate=false}}};function F(ax,az,aA,av,au,i){var aw=document.createElement("div");aw.innerHTML=az;if(aA){aw.id=ax+"_id_"+aA}aw.className=ax+" index_"+av;if(i){aw.extra=i}var ay=function(aC){var aB=parseInt(aC.clientX?aC.clientX:aC.changedTouches[0].clientX);var aD=parseInt(aC.clientY?aC.clientY:aC.changedTouches[0].clientY);if(aB==n&&aD==m){aC.stopPropagation();au($(this))}};if(checkMobile()){aw.addEventListener("touchend",ay)}else{aw.addEventListener("mouseup",ay)}return aw}function q(ax,aC,aB,az,aA){var au=Math.pow(aC*aC+aB*aB+az*az,0.5);var av=new THREE.CSS3DObject(ax);aA=aA?aA:0;var aD=ah().setPosition(v3(0,0,-au*v));var ay=function(i,aF){var aE=Math.acos(aF/Math.pow(i*i+aF*aF,0.5));return i<0?2*PI-aE:aE};if(aA){av.matrix.makeRotationX(aA)}else{av.matrix.makeRotationX(aB/au*PI/2)}av.matrix.multiplyMatrices(ah().makeRotationY(ay(aC,az)+PI),av.matrix);av.matrix.elements[12]=aC;av.matrix.elements[13]=aB;av.matrix.elements[14]=az;if(ax.id){av.name=ax.id}for(var aw=0;aw<12;++aw){av.matrix.elements[aw]*=v}av.matrixAutoUpdate=false;scene.add(av)}function V(aH){if(o){return false}al=true;try{var az=parseInt(aH.clientX?aH.clientX:aH.changedTouches[0].clientX);var ay=parseInt(aH.clientY?aH.clientY:aH.changedTouches[0].clientY)}catch(aI){k(aI)}j=false;if(az==n&&ay==m&&!config.local){var aB=new THREE.Vector2();aB.x=(az/window.innerWidth)*2-1;aB.y=-(ay/window.innerHeight)*2+1;if(config.useCSS3D){var aD=az;var aC=ay;var aG=camera.fov;var av=window.innerWidth;var au=window.innerHeight;var aL=S.width();var aK=S.height();O=-(aD-av/2)/au*aG*PI/180*window.innerHeight/aK;R=(au/2-aC)/au*aG*PI/180*window.innerWidth/aL;var aw=W/3;var aJ=ah();var ax=new THREE.Matrix4().makeRotationY(O+PI/2);var aE=ax.multiply(ah().makeRotationZ(R));var aA=ah().fromArray(camera.matrix.clone().elements);aJ.makeRotationY(-PI/2);aJ.multiplyMatrices(aE,aJ);
             aJ.multiplyMatrices(aA,aJ);ar=v3(0,0,-aw*v).applyProjection(aJ);o=true;if(config.type=="edit"){ar.x*=0.8;ar.y*=0.8;ar.z*=0.8;$(".romaing-editor").show();$(".romaing-editor").find(".buttons").addClass("hide");$(".romaing-editor").find(".editor-add").removeClass("hide");if($(".item")){$(".item").eq(0).click()}}else{o=false;return;initAlert("comment",{title:"添加评论",buttons:[{text:"取消",className:"btn-comment-cancel",callBack:function(){$(".textarea-comment").blur();$(".alert-wrap").css("visibility","hidden");o=false}},{text:"发布",className:"btn-comment-post",color:"red",callBack:function(){if($(".textarea-comment").val().length==0){$(".textarea-comment").attr("placeholder","评论不能为空");return}$(".textarea-comment").blur();$.ajax({url:"/comment-post",type:"POST",async:false,timeout:1000,data:{position_x:ar.x,position_y:ar.y,position_z:ar.z,text:$(".textarea-comment").val(),reply_id:0,scene_id:config.scene_id},success:function(aM){if(aM.code!="0"){alert(aM.msg);return}$(".alert-wrap").css("visibility","hidden");var aN=F("comment",$(".textarea-comment").val(),aM.id,"?",w);q(aN,ar.x,ar.y,ar.z);o=false},error:function(aM){alert(aM)}})}}]});$(".alert-wrap").css("visibility","visible")}return}else{var aF=new THREE.Raycaster();aF.setFromCamera(aB,camera);var i=aF.intersectObjects(an);if(i.length==1){points=i[0].point;scene.add(U(points.x*0.85,points.y*0.85,points.z*0.85,10,0,0))}}}}function p(i){if(i.wheelDeltaY){camera.fov-=i.wheelDeltaY*0.05}else{if(i.wheelDelta){camera.fov-=i.wheelDelta*0.05}else{if(i.detail){camera.fov+=i.detail*1}}}camera.fov=camera.fov>y?y:camera.fov;camera.fov=camera.fov<f?f:camera.fov;camera.updateProjectionMatrix()}function k(i){console.log(i);$("#console").append(i)}function ae(){requestAnimationFrame(ae);if(!o){Q()}}function Q(){if(j===false&&config.autoRotate){g+=0.1}P=Math.max(-85,Math.min(85,P));at=THREE.Math.degToRad(90-P);x=THREE.Math.degToRad(g);camera.target.x=Math.sin(at)*Math.cos(x)+aa;camera.target.y=Math.cos(at)+Z;camera.target.z=Math.sin(at)*Math.sin(x)+Y;camera.position.z=Y;camera.position.y=Z;camera.position.x=aa;camera.lookAt(camera.target);camera.updateMatrix();T.render(scene,camera);if(config.debug){ab.update()}}},500)});
